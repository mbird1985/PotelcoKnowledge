{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <h2 class="text-2xl font-semibold text-teal-800">Analytics Dashboard</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <p class="text-orange-500 text-center">{{ messages[0] }}</p>
    {% endif %}
  {% endwith %}

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Jobs Scheduled This Week -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-xl font-semibold text-teal-800 mb-4">Jobs This Week</h3>
      <p class="text-3xl font-bold text-orange-500">{{ jobs_this_week|default(0) }}</p>
    </div>
    <!-- Total Hours This Week -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-xl font-semibold text-teal-800 mb-4">Total Hours This Week</h3>
      <p class="text-3xl font-bold text-orange-500">{{ total_hours|default(0) }} hrs</p>
    </div>
    <!-- Equipment Due for Maintenance -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-xl font-semibold text-teal-800 mb-4">Equipment Due for Maintenance</h3>
      <p class="text-3xl font-bold text-orange-500">{{ maintenance_due_count|default(0) }}</p>
    </div>
  </div>

  <!-- Maintenance Due Chart (if any equipment is due) -->
  {% if maintenance_due_count > 0 %}
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-teal-800 mb-4">Maintenance Due Details</h3>
    <canvas id="maintenanceChart"></canvas>
  </div>
  {% endif %}
</div>

{% if maintenance_due_count > 0 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  try {
    const maintenanceCtx = document.getElementById('maintenanceChart').getContext('2d');
    new Chart(maintenanceCtx, {
      type: 'bar',
      data: {
        labels: {{ maintenance_due_labels|default([])|tojson }},
        datasets: [{
          label: 'Hours Operated',
          data: {{ maintenance_due_hours|default([])|tojson }},
          backgroundColor: '#F47920'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Hours' } }
        },
        plugins: {
          legend: { display: true },
          title: { display: true, text: 'Equipment Due for Maintenance' }
        }
      }
    });
  } catch (error) {
    console.error('Chart rendering failed:', error);
    document.querySelector('.space-y-6').innerHTML += '<p class="text-red-500 text-center">Error loading chart. Please try again later.</p>';
  }
</script>
{% endif %}
{% endblock %}