{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <h2 class="text-2xl font-semibold text-teal-800">Schedule Detail</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <p class="text-orange-500 text-center">{{ message }}</p>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="bg-white p-6 rounded-lg shadow-md">
    <form method="POST" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-teal-800 font-medium">Start Date:</label>
          <input type="date" name="start_date" value="{{ event.start_date }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">End Date:</label>
          <input type="date" name="end_date" value="{{ event.end_date }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Start Time:</label>
          <input type="time" name="start_time" value="{{ event.start_time }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">End Time:</label>
          <input type="time" name="end_time" value="{{ event.end_time }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Job:</label>
          <input type="text" name="job" value="{{ event.job }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Job Number:</label>
          <input type="text" name="job_number" value="{{ event.job_number }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
        <div class="md:col-span-2">
          <label class="block text-teal-800 font-medium">Description:</label>
          <textarea name="description" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">{{ event.description }}</textarea>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Location:</label>
          <input type="text" name="location" value="{{ event.location }}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Status:</label>
          <select name="status" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
            <option value="scheduled" {% if event.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
            <option value="in_progress" {% if event.status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="completed" {% if event.status == 'completed' %}selected{% endif %}>Completed</option>
            <option value="cancelled" {% if event.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
          </select>
        </div>
      </div>
      <div class="flex justify-center gap-4">
        <button type="submit" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">Update</button>
        <button type="submit" name="delete" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Delete</button>
      </div>
    </form>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-teal-800 mb-4">Assigned Resources</h3>
    <div id="assigned-resources" class="space-y-2">
      {% for resource in resources %}
        <div class="resource-item flex justify-between items-center p-2 border-b border-gray-200" data-id="{{ resource.resource_id }}" data-type="{{ resource.resource_type }}">
          <span>{{ resource.name }} ({{ resource.resource_type }}) - Qty: {{ resource.quantity }}</span>
          <form method="POST">
            <input type="hidden" name="resource_id" value="{{ resource.id }}">
            <button type="submit" name="remove_resource" class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600">Remove</button>
          </form>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-teal-800 mb-4">Add Equipment</h3>
    <form method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-teal-800 font-medium">Equipment:</label>
          <select name="resource_id" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
            {% for item in equipment %}
              <option value="{{ item.id }}">{{ item.name }} ({{ item.status }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Quantity:</label>
          <input type="number" name="quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
      </div>
      <div class="flex justify-center">
        <input type="hidden" name="resource_type" value="equipment">
        <button type="submit" name="add_resource" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">Add</button>
      </div>
    </form>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-teal-800 mb-4">Add People</h3>
    <form method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-teal-800 font-medium">Person:</label>
          <select name="resource_id" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
            {% for person in people %}
              <option value="{{ person.id }}">{{ person.name }} ({{ person.job_title or 'N/A' }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <input type="hidden" name="resource_type" value="person">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" name="add_resource" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 mt-6">Add</button>
        </div>
      </div>
    </form>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-teal-800 mb-4">Add Consumables</h3>
    <form method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-teal-800 font-medium">Consumable:</label>
          <select name="resource_id" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
            {% for item in consumables %}
              <option value="{{ item.id }}">{{ item.name }} ({{ item.stock }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-teal-800 font-medium">Quantity:</label>
          <input type="number" name="quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
        <div>
          <input type="hidden" name="resource_type" value="consumable">
          <button type="submit" name="add_resource" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 mt-6">Add</button>
        </div>
      </div>
    </form>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h4 class="text-lg font-semibold text-teal-800 mb-4">Available Consumables</h4>
    <div id="available-consumables" class="space-y-2">
      {% for item in consumables %}
        <div class="resource-item p-2 border-b border-gray-200" data-id="{{ item.id }}" data-type="consumable">
          {{ item.name }} ({{ item.stock }})
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script src="/static/sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var assigned = document.getElementById('assigned-resources');
    var consumablesEl = document.getElementById('available-consumables');

    Sortable.create(assigned, {
      group: 'resources',
      animation: 150,
      ghostClass: 'bg-orange-100',
      onAdd: function(evt) {
        var item = evt.item;
        var type = item.dataset.type;
        var id = item.dataset.id;
        var quantity = type === 'consumable' ? prompt(`Enter quantity for ${item.textContent.trim()} (default 1):`, "1") || 1 : 1;
        var form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
          <input type="hidden" name="resource_type" value="${type}">
          <input type="hidden" name="resource_id" value="${id}">
          <input type="hidden" name="quantity" value="${quantity}">
          <button type="submit" name="add_resource" class="hidden">Add</button>
        `;
        document.body.appendChild(form);
        form.querySelector('button').click();
      }
    });

    Sortable.create(consumablesEl, { group: { name: 'resources', pull: 'clone', put: false }, animation: 150 });
  });
</script>
{% endblock %}